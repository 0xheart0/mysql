--echo #
--echo # Test general query log superuser filtering
--echo #

--source include/not_embedded.inc

SET @old_general_log= @@global.general_log;
SET @old_general_log_file= @@global.general_log_file;

CREATE USER user1;
CREATE TABLE t1 (a INT PRIMARY KEY, b INT) ENGINE=InnoDB;
DROP TABLE t1;

SET GLOBAL general_log = 0;
SET GLOBAL general_log_super_only = 1;

--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
eval set global general_log_file='$MYSQLTEST_VARDIR/tmp/super_only.log';
SET GLOBAL general_log = 1;
SET GLOBAL general_log_super_only = 1;
SET GLOBAL general_log_query_error = 1;

CREATE TABLE t1 (a INT PRIMARY KEY, b INT) ENGINE=InnoDB;

connect(con1,localhost,root,,);
BEGIN;
INSERT INTO t1 VALUES (1, 1);
INSERT INTO t1 VALUES (2, 2);
--error ER_DUP_ENTRY
INSERT INTO t1 SELECT 1, SLEEP(2);

connect(con1user1,localhost,user1,,);
BEGIN;
INSERT INTO t1 VALUES (3, 3);
INSERT INTO t1 SELECT 4, SLEEP(2);
UPDATE t1 SET b=33 WHERE a=3;

--replace_result $MASTER_MYSOCK MASTER_SOCKET $MASTER_MYPORT MASTER_PORT
--error ER_ACCESS_DENIED_ERROR
connect(con2fake,localhost,user2,,);

disconnect con1;
disconnect con1user1;
--echo # Connection: default
connection default;

DROP TABLE t1;
DROP USER user1;

let GEN_QUERY_LOG_FILE = `SELECT @@GLOBAL.general_log_file`;

perl;
  my $log_file = $ENV{'GEN_QUERY_LOG_FILE'};
  open(FILE, $log_file) or die("Cannot open '$log_file': $!\n");
  my $count = grep /ERROR/, <FILE>;
  $count or die("Cannot find 'ERROR' in '$log_file'\n");
  seek(FILE,0,0);
  my $updc = grep /UPDATE/, <FILE>;
  $updc == 0 or die("Cannot find 'UPDATE' in '$log_file'\n");
  close(FILE)
EOF

SET global general_log = @old_general_log;
SET global general_log_file = @old_general_log_file;
SET GLOBAL general_log_super_only = 0;
SET GLOBAL general_log_query_error = 0;
