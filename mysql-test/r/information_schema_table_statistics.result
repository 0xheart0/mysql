#
# Statistics counters for table handler operations.
#
CREATE TABLE t1 (a INT PRIMARY KEY, b INT) ENGINE=InnoDB;
CREATE TABLE t2 (a INT, b INT) ENGINE=InnoDB;
#
# Test that counters are properly incremented and exported.
#
INSERT INTO t1 VALUES (1,1),(2,2),(3,3),(4,4),(5,5);
SELECT * FROM t1 WHERE a > 4;
a	b
5	5
SELECT * FROM t1 WHERE a = 1;
a	b
1	1
SELECT * FROM t1 LIMIT 1;
a	b
1	1
SELECT * FROM t1 ORDER BY a DESC;
a	b
5	5
4	4
3	3
2	2
1	1
UPDATE t1 SET b = 1 WHERE a > 3;
DELETE FROM t1 WHERE a > 2;
SELECT * FROM INFORMATION_SCHEMA.TABLE_STATISTICS
WHERE TABLE_SCHEMA = 'test' AND TABLE_NAME = 't1';
TABLE_SCHEMA	test
TABLE_NAME	t1
HANDLER_READ_FIRST	1
HANDLER_READ_LAST	1
HANDLER_READ_KEY	6
HANDLER_READ_NEXT	6
HANDLER_READ_PREV	5
HANDLER_READ_RND	0
HANDLER_READ_RND_NEXT	1
HANDLER_DELETE	3
HANDLER_UPDATE	2
HANDLER_WRITE	5
#
# Test that counters are reset on TRUNCATE TABLE.
#
TRUNCATE TABLE t1;
SELECT * FROM INFORMATION_SCHEMA.TABLE_STATISTICS
WHERE TABLE_SCHEMA = 'test' AND TABLE_NAME = 't1';
TABLE_SCHEMA	test
TABLE_NAME	t1
HANDLER_READ_FIRST	0
HANDLER_READ_LAST	0
HANDLER_READ_KEY	0
HANDLER_READ_NEXT	0
HANDLER_READ_PREV	0
HANDLER_READ_RND	0
HANDLER_READ_RND_NEXT	0
HANDLER_DELETE	0
HANDLER_UPDATE	0
HANDLER_WRITE	0
#
# Test that counters are reset on FLUSH TABLE.
#
INSERT INTO t1 VALUES (3,3);
DELETE FROM t1 WHERE a = 3;
SELECT * FROM INFORMATION_SCHEMA.TABLE_STATISTICS
WHERE TABLE_SCHEMA = 'test' AND TABLE_NAME = 't1';
TABLE_SCHEMA	test
TABLE_NAME	t1
HANDLER_READ_FIRST	0
HANDLER_READ_LAST	0
HANDLER_READ_KEY	1
HANDLER_READ_NEXT	0
HANDLER_READ_PREV	0
HANDLER_READ_RND	0
HANDLER_READ_RND_NEXT	0
HANDLER_DELETE	1
HANDLER_UPDATE	0
HANDLER_WRITE	1
FLUSH TABLE t1;
SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLE_STATISTICS WHERE
TABLE_SCHEMA = 'test' AND TABLE_NAME = 't1';
COUNT(*)
0
#
# Test that counters from multiple handlers are accrued.
#
INSERT INTO t1 VALUES (1,1),(2,2),(3,3),(4,4),(5,5);
HANDLER t1 OPEN AS t1_1;
HANDLER t1 OPEN AS t1_2;
HANDLER t1_1 READ `PRIMARY` FIRST;
a	b
1	1
HANDLER t1_2 READ `PRIMARY` LAST;
a	b
5	5
HANDLER t1_1 READ `PRIMARY` NEXT;
a	b
2	2
HANDLER t1_2 READ `PRIMARY` PREV;
a	b
4	4
HANDLER t1_1 READ `PRIMARY` LAST;
a	b
5	5
HANDLER t1_2 READ `PRIMARY` FIRST;
a	b
1	1
HANDLER t1_1 CLOSE;
HANDLER t1_2 CLOSE;
SELECT * FROM INFORMATION_SCHEMA.TABLE_STATISTICS
WHERE TABLE_SCHEMA = 'test' AND TABLE_NAME = 't1';
TABLE_SCHEMA	test
TABLE_NAME	t1
HANDLER_READ_FIRST	2
HANDLER_READ_LAST	2
HANDLER_READ_KEY	4
HANDLER_READ_NEXT	1
HANDLER_READ_PREV	1
HANDLER_READ_RND	0
HANDLER_READ_RND_NEXT	0
HANDLER_DELETE	0
HANDLER_UPDATE	0
HANDLER_WRITE	5
#
# Test that counters are table specific.
#
INSERT INTO t2 SELECT * FROM t1;
SELECT 1 FROM t2 WHERE a = 1;
1
1
UPDATE t2 SET b = 2 WHERE a = 1;
DELETE FROM t2 WHERE a = 1;
SELECT * FROM INFORMATION_SCHEMA.TABLE_STATISTICS
WHERE TABLE_SCHEMA = 'test' AND TABLE_NAME = 't2';
TABLE_SCHEMA	test
TABLE_NAME	t2
HANDLER_READ_FIRST	3
HANDLER_READ_LAST	0
HANDLER_READ_KEY	3
HANDLER_READ_NEXT	0
HANDLER_READ_PREV	0
HANDLER_READ_RND	0
HANDLER_READ_RND_NEXT	18
HANDLER_DELETE	1
HANDLER_UPDATE	1
HANDLER_WRITE	5
#
# Test that counters for locked tables are accrued.
#
FLUSH TABLE t1;
LOCK TABLES t1 WRITE;
SELECT 1 FROM t1 WHERE a = 1;
1
1
UPDATE t1 SET b = 2 WHERE a = 1;
DELETE FROM t1 WHERE a = 1;
INSERT INTO t1 VALUES (1,1);
SELECT * FROM INFORMATION_SCHEMA.TABLE_STATISTICS
WHERE TABLE_SCHEMA = 'test' AND TABLE_NAME = 't1';
TABLE_SCHEMA	test
TABLE_NAME	t1
HANDLER_READ_FIRST	0
HANDLER_READ_LAST	0
HANDLER_READ_KEY	3
HANDLER_READ_NEXT	0
HANDLER_READ_PREV	0
HANDLER_READ_RND	0
HANDLER_READ_RND_NEXT	0
HANDLER_DELETE	1
HANDLER_UPDATE	1
HANDLER_WRITE	1
UNLOCK TABLES;
#
# Test counters for handlers operations spanning multiple connections.
#
FLUSH TABLES t1, t2;
LOCK TABLES t1 READ;
SELECT a FROM t1 WHERE a = 1;
a
1
LOCK TABLES t1 READ;
SELECT a FROM t1 WHERE a = 2;
a
2
SELECT HANDLER_READ_KEY FROM INFORMATION_SCHEMA.TABLE_STATISTICS
WHERE TABLE_SCHEMA = 'test' AND TABLE_NAME = 't1';
HANDLER_READ_KEY	2
UNLOCK TABLES;
LOCK TABLES t2 WRITE;
INSERT INTO t2 VALUES (1,1);
DELETE FROM t2 WHERE a = 1;
UNLOCK TABLES;
LOCK TABLES t1 WRITE;
DELETE FROM t1 WHERE a = 1;
INSERT INTO t1 VALUES (1,1);
SELECT * FROM INFORMATION_SCHEMA.TABLE_STATISTICS
WHERE TABLE_SCHEMA = 'test' AND TABLE_NAME = 't1';
TABLE_SCHEMA	test
TABLE_NAME	t1
HANDLER_READ_FIRST	0
HANDLER_READ_LAST	0
HANDLER_READ_KEY	3
HANDLER_READ_NEXT	0
HANDLER_READ_PREV	0
HANDLER_READ_RND	0
HANDLER_READ_RND_NEXT	0
HANDLER_DELETE	1
HANDLER_UPDATE	0
HANDLER_WRITE	1
SELECT * FROM INFORMATION_SCHEMA.TABLE_STATISTICS
WHERE TABLE_SCHEMA = 'test' AND TABLE_NAME = 't2';
TABLE_SCHEMA	test
TABLE_NAME	t2
HANDLER_READ_FIRST	1
HANDLER_READ_LAST	0
HANDLER_READ_KEY	1
HANDLER_READ_NEXT	0
HANDLER_READ_PREV	0
HANDLER_READ_RND	0
HANDLER_READ_RND_NEXT	6
HANDLER_DELETE	1
HANDLER_UPDATE	0
HANDLER_WRITE	1
# Cleanup.
DROP TABLE t1, t2;
